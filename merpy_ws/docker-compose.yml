services:
  agent:
    image: microros/micro-ros-agent:jazzy
    container_name: merpy_agent
    network_mode: host
    command: ["udp4","--port","8888","-v6"]
    restart: unless-stopped
    environment:
      - ROS_DOMAIN_ID=0
    # For Serial XRCE instead of UDP:
    # command: ["serial","--dev","/dev/ttyACM0","-v6"]
    # devices:
    #   - "/dev/ttyACM0:/dev/ttyACM0"
    # group_add: ["dialout"]

  merpy:
    image: merpy_ws
    build:
      context: .
      dockerfile: docker/Dockerfile
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
        USERNAME: robot
    container_name: merpy_ws
    network_mode: host
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - ROS_DOMAIN_ID=0
    volumes:
      - ./src:/home/robot/ws/src      # mount ONLY your source
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      # Map specific devices only when needed (preferred over /dev):
      # - /dev/ttyACM0:/dev/ttyACM0
      # - /dev/video0:/dev/video0
    group_add:
      - dialout
      - video
    ipc: host
    ulimits:
      memlock: -1
      stack: 67108864
    working_dir: /home/robot/ws
    command: ["bash","-lc","sleep infinity"]  # keep it running for exec shells
    stdin_open: true
    tty: true
    depends_on:
      - agent
